<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --card:rgba(0,0,0,0.6);
      --accent:#2aa;
      --ok:#8f8;
      --nok:#f88;
      --lover:#a61b20;
      --top:#ff5555;
    }

    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background:
        linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
        url("{{ url_for('static', filename='fond.png') }}") center/cover no-repeat;
      color: #fff;
      padding: 20px;
      min-height: 100vh;
    }

    .wrap { max-width: 1100px; margin: 0 auto; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .title { font-size: 20px; font-weight: 700; }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      width: 100%;
    }

    .btn {
      background: var(--accent);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      white-space: nowrap;
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .btn-danger {
      background: #c0392b;
      margin-left: auto;
    }

    .status {
      background: var(--card);
      padding: 10px;
      border-radius: 8px;
    }

    .grid-and-table {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4,1fr);
      gap: 12px;
    }

    .card {
      background: var(--card);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .card.eliminated { opacity: 0.4; filter: grayscale(1); }
    .card.lover { box-shadow: 0 0 10px var(--lover); }

    .img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      margin-bottom: 6px;
    }

    .count {
      background: rgba(255,255,255,0.06);
      padding: 6px;
      border-radius: 8px;
      margin-top: 6px;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .ok { color: var(--ok); font-weight: 700; }
    .ko { color: var(--nok); }
    .top-voted { color: var(--top); font-weight: 700; }
  </style>
</head>

<body>
<div class="wrap">

<!-- HEADER -->
<div class="header">
  <div>
    <div class="title">Admin — Dashboard</div>
    <div class="small" id="voters-count">
      Votants : {{ total_voters }} / {{ joueurs|length }}
    </div>
  </div>

  <div class="controls">
    {% if not admin_started %}
      <a class="btn" href="{{ url_for('admin_start') }}">Start voting</a>
    {% else %}
      <span class="status">Phase de vote active</span>
    {% endif %}

    <a class="btn {% if not all_voted %}secondary{% endif %}"
       href="{{ url_for('admin_reveal') }}">
       Reveal votes
    </a>

    <a class="btn secondary" href="{{ url_for('admin_next_night') }}">Prochaine nuit</a>
    <a class="btn secondary" href="{{ url_for('admin_logout') }}">Logout</a>

    <a class="btn btn-danger"
       href="{{ url_for('reset') }}"
       onclick="return confirm('Nouvelle partie ?');">
       Nouvelle partie
    </a>
  </div>
</div>

<!-- GRID + TABLE -->
<div class="grid-and-table">

<!-- GRID -->
<div class="grid">
{% for j in joueurs %}
  <div id="card-{{ j }}" class="card
       {% if j in eliminated_players %}eliminated{% endif %}
       {% if j in couple_players %}lover{% endif %}">
    <img class="img" src="/static/{{ roles[j]['icon_list'] }}">
    <div>Joueur {{ j }}</div>
    <div class="count" id="votes-card-{{ j }}">Votes : {{ votes[j] }}</div>
    <div id="status-card-{{ j }}">
      {% if j in eliminated_players %}
        <span class="ko">Éliminé</span>
      {% elif j in joueurs_ayant_vote %}
        <span class="ok">A voté</span>
      {% else %}
        <span class="ko">Pas encore</span>
      {% endif %}
    </div>
  </div>
{% endfor %}
</div>

<!-- TABLE -->
<div class="card">
<table>
<thead>
<tr><th>Joueur</th><th>Statut</th><th>Votes</th></tr>
</thead>
<tbody>
{% for j, a in status %}
<tr id="row-{{ j }}">
  <td id="name-{{ j }}">{{ j }}</td>
  <td id="status-row-{{ j }}">
    {% if j in eliminated_players %}
      <span class="ko">Éliminé</span>
    {% elif a %}
      <span class="ok">A voté</span>
    {% else %}
      <span class="ko">Pas encore</span>
    {% endif %}
  </td>
  <td id="votes-row-{{ j }}">{{ votes[j] }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

</div>
</div>

<!-- LIVE UPDATE SCRIPT -->
<script>
(function pollAdmin(){
  const interval = 1200;

  fetch('/api/admin_state')
    .then(r => r.json())
    .then(data => {

      document.getElementById('voters-count').textContent =
        `Votants : ${data.total_voters} / {{ joueurs|length }}`;

      const voted = new Set(data.joueurs_ayant_vote.map(String));
      const eliminated = new Set(data.eliminated_players.map(String));
      const top = new Set(data.top_voted_players.map(String));

      Object.entries(data.votes).forEach(([j,v]) => {
        j = String(j);

        document.getElementById(`votes-card-${j}`).textContent = `Votes : ${v}`;
        document.getElementById(`votes-row-${j}`).textContent = v;

        const status = eliminated.has(j)
          ? '<span class="ko">Éliminé</span>'
          : voted.has(j)
            ? '<span class="ok">A voté</span>'
            : '<span class="ko">Pas encore</span>';

        document.getElementById(`status-card-${j}`).innerHTML = status;
        document.getElementById(`status-row-${j}`).innerHTML = status;

        document.getElementById(`card-${j}`)
          .classList.toggle('eliminated', eliminated.has(j));

        document.getElementById(`name-${j}`)
          .classList.toggle('top-voted',
            data.reveal_results && data.max_votes > 0 && top.has(j)
          );
      });

      setTimeout(pollAdmin, interval);
    })
    .catch(() => setTimeout(pollAdmin, interval));
})();
</script>

</body>
</html>
