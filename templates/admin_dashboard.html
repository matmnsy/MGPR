<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg:#111;
      --card:rgba(0,0,0,0.6);
      --accent:#2aa;
      --ok:#8f8;
      --nok:#f88;
      --lover:#a61b20;
      --top:#ff5555;
    }

    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background:
        linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
        url("{{ url_for('static', filename='fond.png') }}") center/cover no-repeat;
      color: #fff;
      padding: 20px;
      box-sizing: border-box;
      min-height: 100vh;
    }

    .wrap {
      max-width: 1100px;
      width: 95vw;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      width: 100%; /* important pour pousser "Nouvelle partie" à droite */
    }

    .btn {
      background: var(--accent);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      white-space: nowrap;
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .status {
      background: var(--card);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    .grid-and-table {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      margin-top: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4,1fr);
      gap: 12px;
    }

    .card {
      background: var(--card);
      padding: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      box-sizing: border-box;
    }

    .card.eliminated { opacity: 0.4; filter: grayscale(1); }
    .card.lover { box-shadow: 0 0 12px var(--lover); border: 2px solid var(--lover); }

    .img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      object-fit: cover;
      background: #333;
      margin-bottom: 8px;
    }

    .small {
      font-size: 13px;
      color: #ddd;
    }

    .count {
      margin-top: 8px;
      background: rgba(255,255,255,0.06);
      padding: 6px 8px;
      border-radius: 10px;
    }

    .table-wrapper { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }

    th, td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      text-align: left;
      white-space: nowrap;
    }

    .ok { color: var(--ok); font-weight: 700; }
    .ko { color: var(--nok); }
    .lover-text { color: var(--lover); font-weight: 700; }
    .top-voted { color: var(--top); font-weight: 700; }

    .footer {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Responsive tablette */
    @media (max-width: 900px) {
      .grid-and-table { grid-template-columns: 1fr; }
      .grid { grid-template-columns: repeat(3,1fr); }
    }

    /* Responsive mobile */
    @media (max-width: 600px) {
      body { padding: 12px; }
      .title { font-size: 18px; }
      .controls .btn { padding: 7px 10px; font-size: 13px; }
      .grid { grid-template-columns: repeat(2,1fr); gap: 10px; }
      .img { width: 64px; height: 64px; }
      th, td { padding: 6px; font-size: 12px; }
      .status { font-size: 13px; }
      .footer { flex-direction: column; text-align: center; }
    }

    .btn-new-game { margin-left: auto; }
    .btn-danger { background: #c0392b; }
    .btn-danger:hover { background: #e74c3c; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="title">Admin — Dashboard</div>
      <div class="small" id="voters-count">Votants : {{ total_voters }} / {{ joueurs|length }}</div>
    </div>

    <div class="controls">

      {% if not admin_started %}
        <a class="btn" href="{{ url_for('admin_start') }}">Start voting</a>
      {% else %}
        <span class="status">Phase de vote active</span>
      {% endif %}

      <a class="btn {% if not all_voted %}secondary{% endif %}"
         href="{{ url_for('admin_reveal') }}"
         {% if not all_voted %}onclick="return confirm('Tous les joueurs n’ont pas encore voté. Continuer ?');"{% endif %}>
         Reveal votes
      </a>

      <a class="btn secondary"
         href="{{ url_for('admin_next_night') }}"
         onclick="return confirm('Prochaine nuit : réinitialiser les votes, mais garder les joueurs éliminés ?');">
         Prochaine nuit
      </a>

      <a class="btn secondary" href="{{ url_for('admin_esprit_farceur') }}">Esprit farceur</a>
      <a class="btn secondary" href="{{ url_for('admin_couple') }}">Couple maudit</a>
      <a class="btn secondary" href="{{ url_for('admin_necro_chat') }}">Nécro – messages</a>
      <a class="btn secondary" href="{{ url_for('admin_logout') }}">Logout</a>
      <a class="btn secondary" href="{{ url_for('admin_exorciste') }}">Exorciste</a>
      

      <!-- TOUJOURS EN DERNIER -->
      <a class="btn btn-danger btn-new-game"
         href="{{ url_for('reset') }}"
         onclick="return confirm('Nouvelle partie : tout réinitialiser et redistribuer les rôles ?');">
         Nouvelle partie
      </a>

    </div>
  </div>

  <!-- GRID + TABLE -->
  <div class="grid-and-table">

    <!-- GRID -->
    <div>
      <div style="margin-bottom:10px;color:#ddd">
        Grille (aperçu admin) — rôles visibles uniquement ici
      </div>

      <div class="grid">
        {% for j in joueurs %}
          <div id="card-{{ j }}" class="card
               {% if j in eliminated_players %} eliminated{% endif %}
               {% if j in couple_players %} lover{% endif %}">
            <img class="img" src="/static/{{ roles[j]['icon_list'] }}" alt="{{ roles[j]['name'] }}">
            <div>Joueur {{ j }}</div>
            <div class="small">
              {{ roles[j]['name'] }}
              {% if j in couple_players %}
                — <span class="lover-text">Amoureux</span>
              {% endif %}
            </div>
            <div class="count" id="votes-card-{{ j }}">Votes : {{ votes[j] }}</div>

            <div class="small" id="status-card-{{ j }}" style="margin-top:6px">
              {% if j in eliminated_players %}
                <span class="ko">Éliminé</span>
              {% else %}
                {% if j in joueurs_ayant_vote %}
                  <span class="ok">A voté</span>
                {% else %}
                  <span class="ko">Pas encore</span>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Suivi des votants</strong>
        <span class="small">{{ total_voters }} / {{ joueurs|length }}</span>
      </div>

      <table>
        <thead>
        <tr>
          <th>Joueur</th>
          <th>Rôle</th>
          <th>Statut</th>
          <th>Votes</th>
          <th>Action</th>
        </tr>
        </thead>

        <tbody>
        {% for j, a in status %}
          <tr id="row-{{ j }}">
            <td id="name-{{ j }}" class="
              {% if j in couple_players %}lover-text{% endif %}
              {% if reveal_results and j in top_voted_players and max_votes > 0 %} top-voted{% endif %}
            ">
              Joueur {{ j }}
            </td>

            <td>{{ roles[j]['name'] }}</td>

            <td id="status-row-{{ j }}">
              {% if j in eliminated_players %}
                <span class="ko">Éliminé</span>
              {% else %}
                {% if a %}
                  <span class="ok">A voté</span>
                {% else %}
                  <span class="ko">Pas encore</span>
                {% endif %}
              {% endif %}
            </td>

            <td id="votes-row-{{ j }}">{{ votes[j] }}</td>

            <td>
              {% if j in eliminated_players %}
                —
              {% else %}
                <a class="btn secondary"
                   href="{{ url_for('admin_eliminate', joueur=j) }}"
                   onclick="return confirm('Éliminer ce joueur ?');">
                  Éliminer
                </a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div style="margin-top:12px;font-size:13px;color:#ccc">
        <strong>Statut admin :</strong>
        {% if admin_started %} phase ouverte {% else %} en attente {% endif %} —
        {% if reveal_results %} résultats révélés {% else %} résultats cachés {% endif %}
      </div>

    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="small">
      Conseil : "Start voting", puis "Reveal votes".<br>
      "Prochaine nuit" garde les éliminés.
      "Nouvelle partie" relance tout avec de nouveaux rôles.
    </div>

    <div>
      <a class="btn" href="{{ url_for('admin_result') }}"
         {% if not all_voted %}style="opacity:0.5;pointer-events:none;"{% endif %}>
        Voir résultat
      </a>
    </div>
  </div>

</div>

<!-- LIVE UPDATE (nécessite /api/admin_state côté Flask) -->
<script>
(function pollAdmin(){
  const interval = 1200;

  fetch('/api/admin_state')
    .then(r => r.json())
    .then(data => {

      // compteur global
      const votersCount = document.getElementById('voters-count');
      if (votersCount) {
        votersCount.textContent = `Votants : ${data.total_voters} / {{ joueurs|length }}`;
      }

      const voted = new Set((data.joueurs_ayant_vote || []).map(String));
      const eliminated = new Set((data.eliminated_players || []).map(String));
      const top = new Set((data.top_voted_players || []).map(String));

      Object.entries(data.votes || {}).forEach(([j, v]) => {
        j = String(j);

        // GRID votes
        const vc = document.getElementById(`votes-card-${j}`);
        if (vc) vc.textContent = `Votes : ${v}`;

        // GRID statut
        const sc = document.getElementById(`status-card-${j}`);
        if (sc) {
          if (eliminated.has(j)) sc.innerHTML = '<span class="ko">Éliminé</span>';
          else if (voted.has(j)) sc.innerHTML = '<span class="ok">A voté</span>';
          else sc.innerHTML = '<span class="ko">Pas encore</span>';
        }

        // GRID classe eliminated
        const card = document.getElementById(`card-${j}`);
        if (card) card.classList.toggle('eliminated', eliminated.has(j));

        // TABLE votes
        const vr = document.getElementById(`votes-row-${j}`);
        if (vr) vr.textContent = v;

        // TABLE statut
        const sr = document.getElementById(`status-row-${j}`);
        if (sr) {
          if (eliminated.has(j)) sr.innerHTML = '<span class="ko">Éliminé</span>';
          else if (voted.has(j)) sr.innerHTML = '<span class="ok">A voté</span>';
          else sr.innerHTML = '<span class="ko">Pas encore</span>';
        }

        // TABLE top-voted (uniquement après reveal)
        const nameCell = document.getElementById(`name-${j}`);
        if (nameCell) {
          if (data.reveal_results && data.max_votes > 0 && top.has(j)) {
            nameCell.classList.add('top-voted');
          } else {
            nameCell.classList.remove('top-voted');
          }
        }
      });

      setTimeout(pollAdmin, interval);
    })
    .catch(() => setTimeout(pollAdmin, interval));
})();
</script>

</body>
</html>
