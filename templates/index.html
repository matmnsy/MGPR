<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Vote — Joueur {{ votant }}</title>
  <style>
    body{
      margin:0;
      padding-top:40px;
      background:url('/static/fond.png') center/cover no-repeat;
      font-family:Arial;
      color:#fff;
      min-height:100vh;
    }
    .grid{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(4,150px);
      gap:20px;
      justify-content:center;
    }
    .box{
      background:rgba(0,0,0,0.6);
      border-radius:10px;
      padding:12px;
      min-width:150px;
      min-height:150px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color:#fff;
    }
    .box.self{
      background:rgba(80,80,80,0.7);
      cursor:default;
    }
    .box.elim{
      background:rgba(80,80,80,0.4);
      cursor:not-allowed;
      opacity:0.5;
    }
    .img{
      width:80px;
      height:80px;
      border-radius:50%;
      object-fit:cover;
      margin-bottom:8px;
      border:3px solid transparent;
    }
    /* Contour rose si amoureux */
    .lover {
        border-color:#ff77d9 !important;
        box-shadow:0 0 10px #ff77d9;
    }
  </style>
</head>
<body>

  <div class="grid">
    {% for i in range(1,13) %}
      {% set j = i|string %}

      {# 1. Vous-même #}
      {% if j == votant %}
        <div class="box self">
          <img class="img {% if lover_partner == j %}lover{% endif %}" src="/static/{{ roles[j]['icon'] }}" alt="Votre rôle">
          <div>Joueur {{ j }} (vous)</div>
        </div>

      {# 2. Joueur éliminé : on affiche maintenant son image de rôle #}
      {% elif j in eliminated_players %}
        <div class="box elim">
          <img class="img" src="/static/{{ roles[j]['icon'] }}" alt="{{ roles[j]['name'] }}">
          <div>Joueur {{ j }}</div>
        </div>

      {# 3. Autres joueurs #}
      {% else %}
        <a class="box" href="{{ url_for('vote', votant=votant, cible=j) }}">
          <img class="img {% if lover_partner == j %}lover{% endif %}"
               src="/static/role_cache.png"
               alt="Carte cachée">
          <div>Joueur {{ j }}</div>
        </a>
      {% endif %}

    {% endfor %}
  </div>

<script>
(function pollStatus(){
  const interval = 1500;

  fetch('/api/status?votant={{ votant }}')
    .then(r => r.json())
    .then(data => {

      if (data.eliminated) {
        window.location.href = "{{ url_for('vote_page', votant=votant) }}";
        return;
      }

      if (!data.admin_started && !data.reveal) {
        window.location.href = "{{ url_for('vote_page', votant=votant) }}";
        return;
      }

      if (data.reveal) {
        window.location.href = "{{ url_for('vote_page', votant=votant) }}";
        return;
      }

      setTimeout(pollStatus, interval);
    })
    .catch(err => {
      setTimeout(pollStatus, interval);
    });
})();
</script>

</body>
</html>
